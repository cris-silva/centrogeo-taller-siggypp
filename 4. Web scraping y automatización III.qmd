---
title: "4. Web scraping y automatización III"
format: html
editor: visual
---

## Introducción

## Objetivo

## Preparación del entorno

```{r Cargar los paquetes}
library(tidyverse)
library(janitor)
library(rvest)
library(RSelenium)
library(tidygeocoder)
library(sf)
library(tmap)
```

### Iniciar servidor de Selenium

```{r Iniciar Selenium}
servidor_selenium <- rsDriver(browser = "firefox")
```

```{r Crear el controlador del explorador web}
controlador <- servidor_selenium$client
```

### Identificación de los controles de la página

```{r Abrir la página de descarga}
pagina_descarga <- "https://catalogonacionalmhi.inah.gob.mx/consulta_publica/"

controlador$navigate(pagina_descarga)
```

Identifica el botón *Búsqueda avanzada* con el inspector web. Su *xPath* es `//*[@id="mostrarCriterios"]`

```{r Identificar el botón de Búsqueda avanzada}
# Buscar el botón y crearle una instancia para controlarlo
boton_busqueda_avanzada <- controlador$findElement(using = "xpath",
                                                   value = '//*[@id="mostrarCriterios"]')
```

Identifica el menú desplegable de *Entidad Federativa*. Su *xPath* es `//*[@id="entidad_federativa_id"]` . Añade `/option` al final del xPath para indicar que quieres obtener las opciones del selector.

```{r Identificar el menú de Entidad Federativa y sus opciones seleccionables}
# Buscar la lista desplegable y obtener los elementos que contiene
selector_entidad_federativa <- controlador$findElements(using = "xpath",
                                                       value = '//*[@id="entidad_federativa_id"]/option')

# Cuántos elementos tiene el selector?
total_opciones_entidad_federativa <- length(selector_entidad_federativa)

# Comprobar qué elementos contiene el selector
for(opcion in 1:total_opciones_entidad_federativa) {
  print(selector_entidad_federativa[[opcion]]$getElementText()[[1]])
}
```

La primer opción `"Selecciona una opción"` no permite hacer ninguna consulta, así que se descartará para hacer el *scraping*.

Identifica el botón *Buscar* para hacer la consulta:

```{r Identificar el botón Buscar}
# Buscar el botón y crearle una instancia para controlarlo
boton_buscar <- controlador$findElement(using = "xpath",
                                        value = '//*[@id="buscarObjeto"]')
```

### Automatización de las consultas

```{r Presionar el botón de Búsqueda avanzada}
# Presionar el botón Búsqueda avanzada
boton_busqueda_avanzada$clickElement()
```

```{r Seleccionar un estado de la lista desplegable}
# Seleccionar un estado
selector_entidad_federativa[[2]]$clickElement()
```

```{r Presionar el botón Buscar}
# Presionar el botón Buscar para hacer la consulta
boton_buscar$clickElement()
```

```{r Espera de la carga de resultados}
# Esperar a que se carguen los resultados
Sys.sleep(5)
```

Extraer los elementos de los resultados:

```{r}
resultados_consulta <- controlador$findElements(using = "css selector",
                                                value = 'div#col-md-2')

# /html/body/div[2]/div[4]/div[4]/div[4]/div[2]/div/div[1]/div/div[2]/div/div[1]/div[3]
```
